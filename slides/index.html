<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Build infrastructure as a code (IaC) using test-later development (TLD) method</title>

        <meta name="description" content="Presentation with some demo about building infrastructure as a code (IaC) using test-later development (TLD) method">
        <meta name="author" content="Sebastian Czech">

        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="dist/reset.css">
        <link rel="stylesheet" href="dist/reveal.css">
        <link rel="stylesheet" href="dist/theme/black.css">

        <!-- Theme used for syntax highlighted code -->
        <link rel="stylesheet" href="plugin/highlight/monokai.css">
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section data-background="#ffffff">
                    <h2>Test pyramid</h2>
                    <figure>
                        <img src="images/terraformtestingpyramid.png" style="max-height: 450px;">
                        <figcaption><small>source: https://www.hashicorp.com/blog/testing-hashicorp-terraform</small></figcaption>
                    </figure>
                </section>

                <section data-auto-animate>
                    <h2 data-id="code-title">Variables validation # 1</h2>
                    <pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers>
                          variable "my_public_ip" {
                            description = "my public IP address"
                            type        = string
                          }
                    </code></pre>
                </section>

                <section data-auto-animate>
                    <h2 data-id="code-title">Variables validation # 1</h2>
                    <pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers="|4-7|"><script type="text/template">
                          variable "my_public_ip" {
                            description = "my public IP address"
                            type        = string
                            validation {
                              condition     = can(cidrnetmask(var.my_public_ip))
                              error_message = "Public IP address must be a valid IPv4 CIDR"
                            }
                          }
                    </script></code></pre>
                </section>

                <section data-auto-animate>
                    <h2 data-id="code-title">Variables validation # 2</h2>
                    <pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers="|3-4|"><script type="text/template">
                      ingress_security_rules = [
                        {
                          protocol    = 6
                          source      = "0.0.0.0/0"
                          source_type = "CIDR_BLOCK"
                          description = "Allow all for SSH"
                          port        = 22
                        },
                        {
                          protocol    = 6
                          source      = "0.0.0.0/0"
                          source_type = "CIDR_BLOCK"
                          description = "Allow all for HTTPS"
                          port        = 443
                        },
                        {
                          protocol    = 1
                          source      = "0.0.0.0/0"
                          source_type = "CIDR_BLOCK"
                          description = "Allow all for ICMP"
                          icmp_type   = 3
                          icmp_code   = 4
                        }
                      ]
                    </script></code></pre>
                </section>

                <section data-auto-animate>
                    <h2 data-id="code-title">Variables validation # 2</h2>
                    <pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers><script type="text/template">
                      variable "ingress_security_rules" {
                        type    = list(map(string))
                        default = []
                      }
                    </script></code></pre>
                </section>                
                
                <section data-auto-animate>
                    <h2 data-id="code-title">Variables validation # 2</h2>
                    <pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers="|5-6|"><script type="text/template">
                      variable "ingress_security_rules" {
                        type    = list(map(string))
                        default = []
                        validation {
                          condition     = anytrue([for rule in var.ingress_security_rules : rule["source"] == "0.0.0.0/0"])
                          error_message = "At least 1 rule should be defined for 0.0.0.0/0 source"
                        }
                      }
                    </script></code></pre>
                </section>

                <section data-auto-animate>
                    <h2 data-id="code-title">Variables validation # 2</h2>
                    <pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers="|9-10|"><script type="text/template">
                      variable "ingress_security_rules" {
                        type    = list(map(string))
                        default = []
                        validation {
                          condition     = anytrue([for rule in var.ingress_security_rules : rule["source"] == "0.0.0.0/0"])
                          error_message = "At least 1 rule should be defined for 0.0.0.0/0 source"
                        }
                        validation {
                          condition     = alltrue([for rule in var.ingress_security_rules : can(rule["protocol"])])
                          error_message = "Every item in the ingress security rules has to contain procotol"
                        }
                      }
                    </script></code></pre>
                </section>

                <section data-auto-animate>
                    <h2 data-id="code-title">Resource lifecycle validation</h2>
                    <pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers="|31-35|"><script type="text/template">
                        locals {
                            number_of_availability_domains = length(data.oci_identity_availability_domains.ads.availability_domains)
                            instance_image                 = data.oci_core_images.oci_ubuntu_images.images[0].id
                            instance_firmware              = data.oci_core_images.oci_ubuntu_images.images[0].launch_options[0].firmware
                        }
                        resource "oci_core_instance" "k8s_node" {
                            count               = var.instance_count
                            availability_domain = data.oci_identity_availability_domains.ads.availability_domains[count.index % local.number_of_availability_domains].name
                            compartment_id      = var.compartment_id
                            shape               = var.instance_shape
                            source_details {
                              source_id   = local.instance_image
                              source_type = "image"
                            }
                            display_name = "k8s_node${count.index}"
                            create_vnic_details {
                              assign_public_ip = true
                              subnet_id        = oci_core_subnet.k8s_subnet.id
                            }
                            metadata = {
                              # ssh_authorized_keys = file("~/.ssh/id_rsa.pub")
                              ssh_authorized_keys = var.id_rsa_pub
                            }
                            shape_config {
                              baseline_ocpu_utilization = "BASELINE_1_1"
                              memory_in_gbs             = 6
                              ocpus                     = 1
                            }
                            preserve_boot_volume = false

                            lifecycle {
                              precondition {
                                condition     = local.instance_firmware == "UEFI_64"
                                error_message = "Use firmware compatible with 64 bit operating systems"
                            }
                        }
                    </script></code></pre>
                </section>

                <section data-auto-animate>
                    <h2 data-id="code-title">Terratest</h2>
                    <pre data-id="code-animation"><code class="hljs" data-trim data-line-numbers="|3-7|10-13|16-17|"><script type="text/template">
                        func TestOutputsForK8sOciModule(t *testing.T) {
                            // given
                            terraformOptions := terraform.WithDefaultRetryableErrors(t, &terraform.Options{
                                TerraformDir: "../",
                                Logger:       logger.Discard,
                            })
                            defer terraform.Destroy(t, terraformOptions)

                            // when
                            terraform.InitAndApply(t, terraformOptions)
                            fmt.Print("========================\nchecking terraform output\n========================\n")
                            subnet_cidr := terraform.Output(t, terraformOptions, "subnet_cidr")
                            vcn_cidr := terraform.Output(t, terraformOptions, "vcn_cidr")

                            // then
                            assert.Equal(t, "172.16.0.0/24", subnet_cidr)
                            assert.Equal(t, "172.16.0.0/20", vcn_cidr)
                        }
                    </script></code></pre>
                </section>

                <section>
                    <h2>TDD vs TLD</h2>
                    <p class="fragment grow">development time</p>
                    <p class="fragment grow">learning curve</p>
                    <p class="fragment grow">increase productivity</p>
                    <p class="fragment grow">code simplicity</p>
                    <!-- source: https://medium.com/swlh/tdd-vs-tld-and-what-is-the-minimum-code-coverage-needed-f380181d3400 -->
                </section>
            </div>
        </div>

        <script src="dist/reveal.js"></script>
        <script src="plugin/zoom/zoom.js"></script>
        <script src="plugin/notes/notes.js"></script>
        <script src="plugin/search/search.js"></script>
        <script src="plugin/markdown/markdown.js"></script>
        <script src="plugin/highlight/highlight.js"></script>
        <script>
            // More info about initialization & config:
            // - https://revealjs.com/initialization/
            // - https://revealjs.com/config/
            Reveal.initialize({
                controls: true,
                progress: true,
                center: true,
                hash: true,

                // Learn about plugins: https://revealjs.com/plugins/
                plugins: [ RevealZoom, RevealNotes, RevealSearch, RevealMarkdown, RevealHighlight ]
            });
        </script>
    </body>
</html>
